package com.gl.security;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
public class UserController {

    @Autowired
    UserRepo userRepo;

    @Autowired
    RoleRepo roleRepo;

    // =========================
    // Create a new Role
    // =========================
    @PostMapping("/create-role")
    public String createRole(String name) {
        if (roleRepo.findByName(name).isEmpty()) {
            Role role = new Role();
            role.setName(name);
            roleRepo.save(role);
            return "Role created";
        } else {
            return "Role name already taken";
        }
    }

    // =========================
    // Create a new User and assign a Role
    // =========================
    @PostMapping("/create-user")
    public String createUser(String username, String password, String roleName) {
        // Check if role exists
        if (roleRepo.findByName(roleName).isEmpty()) {
            return "Invalid role";
        }

        Role role = roleRepo.findByName(roleName).get();

        // Check if username is already taken
        if (userRepo.findByUsername(username).isEmpty()) {
            // Create new user
            User user = new User(username, password);
            user.getRoles().add(role); // Assign role to user
            userRepo.save(user);       // Save user to DB
            return "User created";
        } else {
            return "Username is already taken";
        }
    }
}
